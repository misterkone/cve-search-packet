#!/usr/bin/env python
import socket
import dpkt
import pymongo
import sys
import os


fichier=sys.argv[1]
cve=""
src_ip=""
def parse_entete(fichier):
  global cve
  global src_ip
  f=open(fichier)
  pcap = dpkt.pcap.Reader(f)
  for ts, buf in pcap:
       eth = dpkt.ethernet.Ethernet(buf)
       ip = eth.data
       tcp = ip.data
       src_ip=socket.inet_ntoa(ip.src)
       if tcp.dport == 80 and len(tcp.data) > 0:
                   http = dpkt.http.Request(tcp.data)
                   cve = http.headers['user-agent']
                   print (src_ip,"User-agent:", cve)
                   return cve

def recherche(cve): 
 connect = pymongo.Connection()
 db = connect.cvedb
 collection = db.cves
 e = {}
 e = db.cpe.find()
 for key  in e:
    result= cve[62:69].lower() + ":" + cve[70:]
    if result[0:] in key['id']:
      print (src_ip, (key['id']))
      return (key['id'])   

if __name__ == "__main__":
   parse_entete(fichier=sys.argv[1])      
if __name__ == "__main__":
   recherche(cve)


